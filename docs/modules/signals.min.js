function cycleDetected(){throw Error("Cycle detected")}function mutationDetected(){throw Error("Computed cannot have side-effects")}let identifier=Symbol.for("preact-signals"),RUNNING=1,NOTIFIED=2,OUTDATED=4,DISPOSED=8,HAS_ERROR=16,TRACKING=32;function startBatch(){batchDepth++}function endBatch(){if(batchDepth>1){batchDepth--;return}let t,e=!1;for(;void 0!==batchedEffect;){let o=batchedEffect;for(batchedEffect=void 0,batchIteration++;void 0!==o;){let i=o._nextBatchedEffect;if(o._nextBatchedEffect=void 0,o._flags&=-3,!(8&o._flags)&&needsToRecompute(o))try{o._callback()}catch(r){e||(t=r,e=!0)}o=i}}if(batchIteration=0,batchDepth--,e)throw t}function batch(t){if(batchDepth>0)return t();startBatch();try{return t()}finally{endBatch()}}let evalContext,untrackedDepth=0;function untracked(t){if(untrackedDepth>0)return t();let e=evalContext;evalContext=void 0,untrackedDepth++;try{return t()}finally{untrackedDepth--,evalContext=e}}let batchedEffect,batchDepth=0,batchIteration=0,globalVersion=0;function addDependency(t){if(void 0===evalContext)return;let e=t._node;return void 0===e||e._target!==evalContext?(e={_version:0,_source:t,_prevSource:evalContext._sources,_nextSource:void 0,_target:evalContext,_prevTarget:void 0,_nextTarget:void 0,_rollbackNode:e},void 0!==evalContext._sources&&(evalContext._sources._nextSource=e),evalContext._sources=e,t._node=e,32&evalContext._flags&&t._subscribe(e),e):-1===e._version?(e._version=0,void 0!==e._nextSource&&(e._nextSource._prevSource=e._prevSource,void 0!==e._prevSource&&(e._prevSource._nextSource=e._nextSource),e._prevSource=evalContext._sources,e._nextSource=void 0,evalContext._sources._nextSource=e,evalContext._sources=e),e):void 0}function Signal(t){this._value=t,this._version=0,this._node=void 0,this._targets=void 0}function signal(t){return new Signal(t)}function needsToRecompute(t){for(let e=t._sources;void 0!==e;e=e._nextSource)if(e._source._version!==e._version||!e._source._refresh()||e._source._version!==e._version)return!0;return!1}function prepareSources(t){for(let e=t._sources;void 0!==e;e=e._nextSource){let o=e._source._node;if(void 0!==o&&(e._rollbackNode=o),e._source._node=e,e._version=-1,void 0===e._nextSource){t._sources=e;break}}}function cleanupSources(t){let e=t._sources,o;for(;void 0!==e;){let i=e._prevSource;-1===e._version?(e._source._unsubscribe(e),void 0!==i&&(i._nextSource=e._nextSource),void 0!==e._nextSource&&(e._nextSource._prevSource=i)):o=e,e._source._node=e._rollbackNode,void 0!==e._rollbackNode&&(e._rollbackNode=void 0),e=i}t._sources=o}function Computed(t){Signal.call(this,void 0),this._compute=t,this._sources=void 0,this._globalVersion=globalVersion-1,this._flags=4}function computed(t){return new Computed(t)}function cleanupEffect(t){let e=t._cleanup;if(t._cleanup=void 0,"function"==typeof e){startBatch();let o=evalContext;evalContext=void 0;try{e()}catch(i){throw t._flags&=-2,t._flags|=8,disposeEffect(t),i}finally{evalContext=o,endBatch()}}}function disposeEffect(t){for(let e=t._sources;void 0!==e;e=e._nextSource)e._source._unsubscribe(e);t._compute=void 0,t._sources=void 0,cleanupEffect(t)}function endEffect(t){if(evalContext!==this)throw Error("Out-of-order effect");cleanupSources(this),evalContext=t,this._flags&=-2,8&this._flags&&disposeEffect(this),endBatch()}function Effect(t){this._compute=t,this._cleanup=void 0,this._sources=void 0,this._nextBatchedEffect=void 0,this._flags=32}function effect(t){let e=new Effect(t);try{e._callback()}catch(o){throw e._dispose(),o}return e._dispose.bind(e)}Signal.prototype.brand=identifier,Signal.prototype._refresh=function(){return!0},Signal.prototype._subscribe=function(t){this._targets!==t&&void 0===t._prevTarget&&(t._nextTarget=this._targets,void 0!==this._targets&&(this._targets._prevTarget=t),this._targets=t)},Signal.prototype._unsubscribe=function(t){if(void 0!==this._targets){let e=t._prevTarget,o=t._nextTarget;void 0!==e&&(e._nextTarget=o,t._prevTarget=void 0),void 0!==o&&(o._prevTarget=e,t._nextTarget=void 0),t===this._targets&&(this._targets=o)}},Signal.prototype.subscribe=function(t){let e=this;return effect(function(){let o=e.value,i=32&this._flags;this._flags&=-33;try{t(o)}finally{this._flags|=i}})},Signal.prototype.valueOf=function(){return this.value},Signal.prototype.toString=function(){return this.value+""},Signal.prototype.toJSON=function(){return this.value},Signal.prototype.peek=function(){return this._value},Object.defineProperty(Signal.prototype,"value",{get(){let t=addDependency(this);return void 0!==t&&(t._version=this._version),this._value},set(t){if(evalContext instanceof Computed&&mutationDetected(),t!==this._value){batchIteration>100&&cycleDetected(),this._value=t,this._version++,globalVersion++,startBatch();try{for(let e=this._targets;void 0!==e;e=e._nextTarget)e._target._notify()}finally{endBatch()}}}}),Computed.prototype=new Signal,Computed.prototype._refresh=function(){if(this._flags&=-3,1&this._flags)return!1;if((36&this._flags)==32||(this._flags&=-5,this._globalVersion===globalVersion))return!0;if(this._globalVersion=globalVersion,this._flags|=1,this._version>0&&!needsToRecompute(this))return this._flags&=-2,!0;let t=evalContext;try{prepareSources(this),evalContext=this;let e=this._compute();(16&this._flags||this._value!==e||0===this._version)&&(this._value=e,this._flags&=-17,this._version++)}catch(o){this._value=o,this._flags|=16,this._version++}return evalContext=t,cleanupSources(this),this._flags&=-2,!0},Computed.prototype._subscribe=function(t){if(void 0===this._targets){this._flags|=36;for(let e=this._sources;void 0!==e;e=e._nextSource)e._source._subscribe(e)}Signal.prototype._subscribe.call(this,t)},Computed.prototype._unsubscribe=function(t){if(void 0!==this._targets&&(Signal.prototype._unsubscribe.call(this,t),void 0===this._targets)){this._flags&=-33;for(let e=this._sources;void 0!==e;e=e._nextSource)e._source._unsubscribe(e)}},Computed.prototype._notify=function(){if(!(2&this._flags)){this._flags|=6;for(let t=this._targets;void 0!==t;t=t._nextTarget)t._target._notify()}},Computed.prototype.peek=function(){if(this._refresh()||cycleDetected(),16&this._flags)throw this._value;return this._value},Object.defineProperty(Computed.prototype,"value",{get(){1&this._flags&&cycleDetected();let t=addDependency(this);if(this._refresh(),void 0!==t&&(t._version=this._version),16&this._flags)throw this._value;return this._value}}),Effect.prototype._callback=function(){let t=this._start();try{if(8&this._flags||void 0===this._compute)return;let e=this._compute();"function"==typeof e&&(this._cleanup=e)}finally{t()}},Effect.prototype._start=function(){1&this._flags&&cycleDetected(),this._flags|=1,this._flags&=-9,cleanupEffect(this),prepareSources(this),startBatch();let t=evalContext;return evalContext=this,endEffect.bind(this,t)},Effect.prototype._notify=function(){2&this._flags||(this._flags|=2,this._nextBatchedEffect=batchedEffect,batchedEffect=this)},Effect.prototype._dispose=function(){this._flags|=8,1&this._flags||disposeEffect(this)};export{signal,computed,effect,batch,Signal,untracked};