<div class="terminal" id="terminal" tabindex="0">
    <div id="output" class="terminal__output"></div>
    <div class="command-line" id="cmd">
        <span class="command-line__path">amiran@amiran:~$</span>
        <span class="command-line__prompt" id="prompt"></span>
        <span class="command-line__cursor"></span>
    </div>
</div>

<script type="module">
    import ls from '/modules/executables/ls.js';
    import email from '/modules/executables/email.js';

    const $output = document.getElementById('output');
    const $prompt = document.getElementById('prompt');
    const $terminal = document.getElementById('terminal');
    const $cmd = document.getElementById('cmd');

    const print = (text) => {
        if (typeof text !== 'string') {
            try {
                text = JSON.stringify(text);
            } catch (e) {
                text = String(text);
            }
        }

        text = text.split('\n').map(line => line.slice(0, 80)).join('\n');
        $output.textContent += text + '\n';
        $output.scrollTop = $output.scrollHeight;
    };

    const clear = () => $output.textContent = '';

    const exec = async (command) => {
        const args = command.trim().split(' ');
        const name = args[0];
        const params = args.slice(1).filter(p => p !== '');

        if (commands[name]) {
            const style = $cmd.style.display;
            $cmd.style.display = 'none';
            await commands[name].exec({ print, clear, params });
            $cmd.style.display = style;
        } else {
            print(`Command not found: ${name}`);
        }
    };

    const commands = {
        help: {
            description: 'List all available commands',
            exec: ({ print }) => {
                Object.keys(commands).forEach((command) => {
                    const description = commands[command].description;
                    print(`${command} - ${description}`);
                });
            },
        },
        clear: {
            description: 'Clear the terminal screen',
            exec: clear,
        },
        ...ls,
        ...email,
    };

    let input = '';
    let inputAllowed = true;

    function updateInput() {
        $prompt.innerHTML = input;
    }

    $terminal.addEventListener('keydown', async (e) => {
        if (!inputAllowed) {
            return;
        }

        if (e.keyCode === 13) {
            if (input.trim() === '') {
                return;
            }

            inputAllowed = false;
            await exec(input);
            input = '';
            inputAllowed = true;
        } else if (e.keyCode === 8) {
            input = input.slice(0, -1);
        } else if (e.key.length === 1) {
            input += e.key;
        } else if (e.keyCode === 32) {
            input += ' ';
        }

        updateInput();
    });
</script>